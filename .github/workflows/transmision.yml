name: Transmision Constante
on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar FFmpeg y Python
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-pip
          pip3 install requests

      - name: Descargar Archivos (Modo Seguro)
        shell: python
        run: |
          import requests
          files = {
              "vid1.mp4": "https://www.dropbox.com/scl/fi/v5p2c4jpbczpeyo90gjn5/programa1.mp4?rlkey=dgjjbx2er3hfdpc9m117wp0c2&st=l5cstbfh&dl=1",
              "vid2.mp4": "https://www.dropbox.com/scl/fi/48dngz7t9xtbn18h6v839/programa2.mp4?rlkey=lms05w9e81b5suv5idnsz2e90&st=f02aau3m&dl=1",
              "logo.png": "https://www.dropbox.com/scl/fi/snh8onwq9gx6zlum089j6/logo.png?rlkey=o5f2vp3q0hyaa513ucmq3sd6w&st=d3zoo3t8&dl=1"
          }
          for name, url in files.items():
              print(f"Descargando {name}...")
              r = requests.get(url, allow_redirects=True)
              with open(name, 'wb') as f:
                  f.write(r.content)
          print("Descargas completadas con Ã©xito.")

      - name: Unir Videos
        run: |
          echo "file 'vid1.mp4'" > lista.txt
          echo "file 'vid2.mp4'" >> lista.txt
          ffmpeg -f concat -safe 0 -i lista.txt -c copy final.mp4

      - name: Transmitir
        run: |
          ffmpeg -re -stream_loop -1 -i final.mp4 -i logo.png \
          -filter_complex "[1:v]scale=180:-1[l];[0:v][l]overlay=120:40" \
          -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1500k \
          -maxrate 1500k -bufsize 3000k -pix_fmt yuv420p \
          -c:a aac -b:a 128k -f flv \
          "rtmp://vs20.live.opencaster.com/opencaster/cristianhilos_314b91b0?psk=cristianhilos_314b91b0&tk=b77f89cbf4f83af5295e37a562a3379de814c3a945e7402811a589c00d91f442"
